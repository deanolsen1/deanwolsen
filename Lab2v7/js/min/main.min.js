function initialize(){setMap()}function setMap(){function e(e,r,a,o){colorize=colorScale(r);for(var i=a.objects.camden.geometries,s=0;s<r.length;s++)for(var l=r[s],c=l.LSOA11CD,d=0;d<i.length;d++)if(i[d].properties.LSOA11CD==c){for(var p in keyArray){var h=keyArray[p],u=parseFloat(l[h]);i[d].properties[h]=u}i[d].properties.LSOA11CD=l.LSOA11CD;break}{var o=t.append("path").datum(topojson.feature(o,o.objects.london)).attr("class","London").attr("d",n).style("fill","#F5FAFF");t.selectAll(".camden").data(topojson.feature(a,a.objects.camden).features).enter().append("g").attr("class","camdenLSOAs").append("path").attr("class",function(e){return e.properties.LSOA11CD}).attr("d",n).style("fill",function(e){return choropleth(e,colorize)}).on("mouseover",highlight).on("mouseout",dehighlight).on("mousemove",moveLabel).append("desc").text(function(e){return choropleth(e,colorize)})}createDropdown(r),setChart(r,colorize)}var t=d3.select("body").append("svg").attr("width",width).attr("height",height).attr("class","map"),r=d3.geo.albers().rotate([.153,0]).center([.003,51.55]).parallels([43,62]).translate([height/2,width/2]).scale(47e4),n=d3.geo.path().projection(r);queue().defer(d3.csv,"data/n_camden_data.csv").defer(d3.json,"data/camden2lite84.topojson").defer(d3.json,"data/london2lite84.topojson").await(e)}function createDropdown(e){var t=d3.select("body").append("div").attr("class","dropdown").html("<h3>Select specific deprivation index:</h3>").append("select").on("change",function(){changeAttribute(this.value,e)});t.selectAll("options").data(keyArray).enter().append("option").attr("value",function(e){return e}).text(function(e){return e=e[0].toUpperCase()+e.substring(1,3)+" "+e.substring(3)})}function setChart(e){var t=d3.select("body").append("svg").attr("width",chartWidth).attr("height",chartHeight).attr("class","chart"),r=(t.append("text").attr("x",10).attr("y",28).attr("class","chartTitle"),t.selectAll(".bar").data(e).enter().append("rect").sort(function(e,t){return e[expressed]-t[expressed]}).attr("class",function(e){return"bar "+e.LSOA11CD}).attr("width",chartWidth/e.length-1).on("mouseover",highlight).on("mouseout",dehighlight).on("mousemove",moveLabel));updateChart(r,e.length)}function updateChart(e,t){e.attr("height",function(e){return 4*Number(e[expressed])}).attr("y",function(e){return chartHeight-4*Number(e[expressed])}).attr("x",function(e,r){return r*(chartWidth/t)}).style("fill",function(e){return choropleth(e,colorize)}),d3.select(".chartTitle").text(expressed[0]+expressed.substring(1,3)+" "+expressed.substring(3)+" Deprivation Index Value by LSOA")}function colorScale(e){var t=d3.scale.quantile().range(["#FEF0D9","#FDCC8A","#FC8D59","#E34A33","#B30000"]),r=[];for(var n in e)r.push(Number(e[n][expressed]));return t.domain(r),t}function choropleth(e,t){var r=Number(e.properties?e.properties[expressed]:e[expressed]);return r?t(r):"#ccc"}function changeAttribute(e,t){expressed=e,colorize=colorScale(t),d3.selectAll(".camdenLSOAs").select("path").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)});var r=d3.selectAll(".bar").sort(function(e,t){return e[expressed]-t[expressed]}).transition().delay(function(e,t){return 10*t});updateChart(r,t.length)}function highlight(e){var t=e.properties?e.properties:e;d3.selectAll("."+t.LSOA11CD).style("fill","#000");{var r="<h1>"+expressed+" Score: "+t[expressed]+"</h1><b>";t.LSOA11CD,d3.select("body").append("div").attr("class","infolabel").attr("id",t.LSOA11CD+"label").html(r).append("div").attr("class","labelname").text("LSOA #"+t.LSOA11CD)}}function dehighlight(e){var t=e.properties?e.properties:e,r=d3.selectAll("."+t.LSOA11CD),n=r.select("desc").text();r.style("fill",n),d3.select("#"+t.LSOA11CD+"label").remove()}function moveLabel(){var e=d3.event.clientX<window.innerWidth-210?d3.event.clientX+10:d3.event.clientX-170,t=d3.event.clientY<window.innerHeight-10?d3.event.clientY-75:d3.event.clientY-175;d3.select(".infolabel").style("margin-left",e+"px").style("margin-top",t+"px")}function openFirstPanel(){$(".accordion > dt:first-child").next().addClass("active").slideDown()}var keyArray=["IMD","Income","Employment","Education","Housing","Environment"],expressed=keyArray[0],colorize,chartWidth=450,chartHeight=325,width=560,height=650;window.onload=initialize(),function(e){var t=e(".accordion > dd").hide();openFirstPanel(),e(".accordion > dt > a").click(function(){return $this=e(this),$target=$this.parent().next(),$target.hasClass("active")?$target.removeClass("active").slideUp():(t.removeClass("active").slideUp(),$target.addClass("active").slideDown()),!1})}(jQuery);